'use strict';let authToken;
document.addEventListener("DOMContentLoaded",async function(){var a=window.location.pathname;if(a==="/img_view")console.info("/img_view page accessed, skipping image loading logic.");else{var f=a.startsWith("/a/");a=a.split("/")[2];var b=f?"/is_api/checkAlbumPassword":"/is_api/checkImagePassword",g=f?"/is_api/downloadAlbumImages":"/is_api/downloadSingleImage",d={code:a};try{const c=await (await fetchWithRetry(f?"/is_api/isAlbumPasswordNeeded":"/is_api/isImagePasswordNeeded",d)).json();c.isValid?c.requiresPassword?
    (showPasswordModal(),setupPasswordValidation(b,a,f)):(c.token&&(authToken=c.token),initPage(g,f)):window.location.href="/error_410"}catch(c){window.location.href="/error"}}});
async function initPage(a,f){hidePasswordModal();try{const b=await (await fetch(new URL(a,window.location.origin),{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${authToken}`},body:JSON.stringify({token:authToken})})).json();b.error?alert(b.error):f?await displayImagesSequentially(b):displaySingleImage(b)}catch(b){console.error("Error occurred during initPage execution:",b),alert("\u8f09\u5165\u5716\u7247\u5931\u6557\u8acb\u7a0d\u5f8c\u518d\u8a66\nFailed to load images. Please try again later.")}}
async function displayImagesSequentially(a){const f=document.getElementById("gallery");f.innerHTML="";f.classList.remove("hidden");var b=a.siaEndDate??"N/A",g=a.siaTotalVisited??0;const d=document.createElement("div");d.classList.add("status-area");d.innerHTML=`Expires on: ${b} | Views: ${g}`;f.appendChild(d);const c=document.createElement("div");c.classList.add("page-url-text");b=new URL(window.location.href);const e=b.host+b.pathname;c.innerHTML=`Share Gallery: ${e}`;c.addEventListener("click",
    function(){copyToClipboard(e);showCopiedMessage(c)});b=document.createElement("button");b.classList.add("download-album-button");b.textContent="";b.title="\u4e0b\u8f09\u6240\u6709\u5716\u7247 - Download Gallery";b.addEventListener("click",function(){downloadEntireAlbum(a.images)});g=document.createElement("div");g.classList.add("album-url-container");g.appendChild(c);g.appendChild(b);f.appendChild(g);b=a.siaNsfw===1;for(const h of a.images)await loadImageSequentially(h,f,b)}
function loadImageSequentially(a,f,b){return new Promise(g=>{const d=document.createElement("div");d.classList.add("photo");var c=document.createElement("img");c.src=(new URL(a.imageUrl,window.location.origin)).href;c.alt=a.siName;c.classList.add("gallery-image");c.onerror=function(){this.src="/images/pic_not_found.webp"};c.onload=()=>{g()};if(b){var e=document.createElement("div");e.classList.add("nsfw-mask");e.innerHTML="R15 or R18 Content\x3cbr\x3eNSFW - Click to reveal";e.addEventListener("click",
    ()=>{document.querySelectorAll(".nsfw-mask").forEach(m=>{m.style.display="none"})});d.appendChild(c);d.appendChild(e)}else d.appendChild(c);const h=document.createElement("div");h.classList.add("single-mode-text");h.innerHTML=`Share URL: ${a.imageSingleModeUrl}`;h.addEventListener("click",function(){copyToClipboard(a.imageSingleModeUrl);showCopiedMessage(h)});c=document.createElement("a");c.classList.add("open-link-button");c.textContent="";c.title="\u539f\u59cb\u5c3a\u5bf8 - Full Size";c.href=a.imageUrl;
    c.target="_blank";c.rel="noopener noreferrer";e=document.createElement("a");e.classList.add("download-link-button");e.textContent="";e.title="\u4e0b\u8f09\u5716\u7247 - Download";e.addEventListener("click",async m=>{m.preventDefault();try{const l=await (await fetch(a.imageUrl,{mode:"cors"})).blob(),p=URL.createObjectURL(l),n=document.createElement("a");n.href=p;n.download=a.siName||"download.jpg";document.body.appendChild(n);n.click();document.body.removeChild(n);URL.revokeObjectURL(p)}catch(l){console.error("Download failed:",
        l),alert("\u4e0b\u8f09\u5931\u6557! - Download Failed!")}});const k=document.createElement("div");k.classList.add("url-container");k.appendChild(h);k.appendChild(c);k.appendChild(e);d.appendChild(k);f.appendChild(d)})}
function downloadEntireAlbum(a){if(a&&a.length!==0){var f=new JSZip,b=new URL(window.location.href),g=b.host+b.pathname;g=g.replace(/[\/:?*"<>|]/g,"_");var d=0;a.forEach(c=>{fetch(c.imageUrl).then(e=>e.blob()).then(e=>{let h=c.siName;h=h.replace(/[\/:?*"<>|]/g,"_");f.file(`${h}.jpg`,e);d++;d===a.length&&f.generateAsync({type:"blob"}).then(k=>{saveAs(k,`${g}.zip`)})}).catch(e=>console.error(`Error downloading ${c.imageUrl}:`,e))})}else console.error("No images to download.")}
function displaySingleImage(a){const f=document.getElementById("single-photo");f.innerHTML="";var b=a.siEndDate??"N/A",g=a.siTotalVisited??0,d=document.createElement("div");d.classList.add("status-area");d.innerHTML=`Expires on: ${b} | Views: ${g}`;const c=document.createElement("div");c.classList.add("page-url-text");const e=window.location.href;b=new URL(e);c.innerHTML=`Share URL: ${b.origin+b.pathname}`;c.addEventListener("click",function(){copyToClipboard(e);showCopiedMessage(c)});b=document.createElement("div");
    b.classList.add("photo-url-container");b.appendChild(d);b.appendChild(c);f.appendChild(b);b=document.createElement("div");b.classList.add("photo-wrapper");g=document.createElement("img");d=a.imageUrl.startsWith("http")?a.imageUrl:(new URL(a.imageUrl,window.location.origin)).href;g.src=d;g.alt=a.siName;g.id="photo-img";b.appendChild(g);if(a.siNsfw===1){const h=document.createElement("div");h.classList.add("nsfw-mask");h.textContent="NSFW - Click to reveal";h.addEventListener("click",()=>{h.classList.add("hidden")});
        b.appendChild(h)}f.appendChild(b);a=document.createElement("a");a.classList.add("open-link-button");a.textContent="";a.title="\u539f\u59cb\u5c3a\u5bf8 - Full Size";a.href=d;a.target="_blank";a.rel="noopener noreferrer";d=document.createElement("a");d.classList.add("download-link-button");d.textContent="";d.title="\u4e0b\u8f09\u5716\u7247 - Download";d.addEventListener("click",async h=>{h.preventDefault();try{const k=await (await fetch(image.imageUrl,{mode:"cors"})).blob(),m=URL.createObjectURL(k),
        l=document.createElement("a");l.href=m;l.download=image.siName||"download.jpg";document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(m)}catch(k){console.error("Download failed:",k),alert("\u4e0b\u8f09\u5931\u6557! - Download Failed!")}});b=document.createElement("div");b.classList.add("url-container");b.appendChild(a);b.appendChild(d);f.appendChild(b);f.classList.remove("hidden")}
function showPasswordModal(){const a=document.getElementById("password-modal");a&&a.classList.remove("hidden")}function hidePasswordModal(){const a=document.getElementById("password-modal");a&&a.classList.add("hidden")}
function setupPasswordValidation(a,f,b){const g=document.getElementById("password-form"),d=document.getElementById("password-input"),c=document.getElementById("password-submit");c.disabled=!0;d.addEventListener("blur",function(){const e=d.value.trim();/^\d{4,10}$/.test(e)||e===""||(alert("\u5bc6\u78bc\u683c\u5f0f\u4e0d\u7b26\u5408\u8acb\u8f38\u51654~10\u4f4d\u6578\u5b57\nPassword format is incorrect. Please enter 4-10 digits."),d.value="",c.disabled=!0,setTimeout(()=>{d.focus()},0))});d.addEventListener("input",
    function(){var e=d.value.trim();e=/^\d{4,10}$/.test(e);c.disabled=!e});g.addEventListener("submit",async function(e){e.preventDefault();e=d.value.trim();if(e!==""){e={code:f,password:e};try{const h=await (await fetchWithRetry(a,e)).json();h.checkPassword?(h.token&&(authToken=h.token),hidePasswordModal(),initPage(b?"/is_api/downloadAlbumImages":"/is_api/downloadSingleImage",b)):(alert("\u5bc6\u78bc\u932f\u8aa4\u8acb\u91cd\u65b0\u8f38\u5165\nIncorrect password, please try again."),d.value="",c.disabled=
    !0,setTimeout(()=>{d.focus()},0))}catch(h){alert("\u7cfb\u7d71\u932f\u8aa4\u8acb\u7a0d\u5f8c\u518d\u8a66\nSystem error, please try again later.")}}})}async function fetchWithRetry(a,f,b=3){let g=0;for(;g<b;)try{const d=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});if(d.status===429)await new Promise(c=>setTimeout(c,1E3)),g++;else return d}catch(d){break}throw Error("Too many attempts, please try again later.");}
function copyToClipboard(a){navigator.clipboard.writeText(a).then(()=>{console.log("Text copied to clipboard:",a)}).catch(f=>{console.error("Failed to copy text: ",f)})}function showCopiedMessage(){const a=document.createElement("div");a.textContent="\u5df2\u8907\u88fd\u7db2\u5740 - URL Copied!";a.classList.add("toast-message");document.body.appendChild(a);setTimeout(()=>{document.body.removeChild(a)},1500)}
document.addEventListener("DOMContentLoaded",function(){const a=document.getElementById("scrollToTop");a?(window.addEventListener("scroll",()=>{const f=window.scrollY;a.style.bottom=document.documentElement.scrollHeight-(f+window.innerHeight)<=175?"175px":"40px";f>500?a.classList.add("show"):a.classList.remove("show")}),a.addEventListener("click",()=>{console.log("Back to Top button clicked!");document.documentElement.scrollTo({top:0,behavior:"smooth"});document.body.scrollTo({top:0,behavior:"smooth"})})):
    console.error("Back to Top button not found!")});