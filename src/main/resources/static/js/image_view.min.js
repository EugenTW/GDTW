'use strict';let authToken;
document.addEventListener("DOMContentLoaded",async function(){const a=document.getElementById("scrollToTop");a&&(window.addEventListener("scroll",()=>{const c=window.scrollY;a.style.bottom=document.documentElement.scrollHeight-(c+window.innerHeight)<=175?"175px":"40px";a.classList.toggle("show",c>500)}),a.addEventListener("click",()=>{document.documentElement.scrollTo({top:0,behavior:"smooth"});document.body.scrollTo({top:0,behavior:"smooth"})}));var f=window.location.pathname;if(f!=="/img_view"){var b=
    f.startsWith("/a/");f=f.split("/")[2];var g=b?"/is_api/checkAlbumPassword":"/is_api/checkImagePassword",e=b?"/is_api/downloadAlbumImages":"/is_api/downloadSingleImage",d={code:f};try{const c=await (await fetchWithRetry(b?"/is_api/isAlbumPasswordNeeded":"/is_api/isImagePasswordNeeded",d)).json();c.isValid?c.requiresPassword?(showPasswordModal(),setupPasswordValidation(g,f,b)):(c.token&&(authToken=c.token),initPage(e,b)):window.location.href="/error_410"}catch(c){window.location.href="/error"}}});
async function initPage(a,f){hidePasswordModal();try{const b=await (await fetch(new URL(a,window.location.origin),{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${authToken}`},body:JSON.stringify({token:authToken})})).json();b.error?alert(b.error):f?await displayImagesSequentially(b):displaySingleImage(b)}catch(b){alert("\u8f09\u5165\u5716\u7247\u5931\u6557\u8acb\u7a0d\u5f8c\u518d\u8a66\nFailed to load images. Please try again later.")}}
async function displayImagesSequentially(a){const f=document.getElementById("gallery");f.innerHTML="";f.classList.remove("hidden");var b=a.siaEndDate??"N/A",g=a.siaTotalVisited??0;const e=document.createElement("div");e.classList.add("status-area");e.innerHTML=`Expires on: ${b} | Views: ${g}`;f.appendChild(e);const d=document.createElement("div");d.classList.add("page-url-text");const c=(new URL(window.location.href)).host+window.location.pathname;d.innerHTML=`Share Gallery: ${c}`;d.addEventListener("click",
    ()=>{copyToClipboard(c);showCopiedMessage(d)});b=document.createElement("button");b.classList.add("download-album-button");b.innerHTML="\x26#11015;\x26#65039;";b.title="\u4e0b\u8f09\u6240\u6709\u5716\u7247 - Download Gallery";b.addEventListener("click",()=>{downloadEntireAlbum(a.images)});g=document.createElement("div");g.classList.add("album-url-container");g.appendChild(d);g.appendChild(b);f.appendChild(g);b=a.siaNsfw===1;for(const h of a.images)await loadImageSequentially(h,f,b)}
function loadImageSequentially(a,f,b){return new Promise(g=>{const e=document.createElement("div");e.classList.add("photo");var d=document.createElement("img");d.src=(new URL(a.imageUrl,window.location.origin)).href;d.alt=a.siName;d.classList.add("gallery-image");d.onerror=function(){this.src="/images/pic_not_found.webp"};d.onload=()=>g();if(b){var c=document.createElement("div");c.classList.add("nsfw-mask");c.innerHTML="R15 or R18 Content\x3cbr\x3eNSFW - Click to reveal";c.addEventListener("click",
    ()=>{document.querySelectorAll(".nsfw-mask").forEach(l=>l.style.display="none")});e.appendChild(d);e.appendChild(c)}else e.appendChild(d);const h=document.createElement("div");h.classList.add("single-mode-text");h.innerHTML=`Share : ${a.imageSingleModeUrl}`;h.addEventListener("click",()=>{copyToClipboard(a.imageSingleModeUrl);showCopiedMessage(h)});d=document.createElement("a");d.classList.add("open-link-button");d.innerHTML="\x26#128269;";d.title="\u539f\u59cb\u5c3a\u5bf8 - Full Size";d.href=a.imageUrl;
    d.target="_blank";d.rel="noopener noreferrer";c=document.createElement("a");c.classList.add("download-link-button");c.innerHTML="\x26#11015;\x26#65039;";c.title="\u4e0b\u8f09\u5716\u7247 - Download";c.addEventListener("click",async l=>{l.preventDefault();downloadByUrl(a.imageUrl,a.siName||"download.jpg")});const k=document.createElement("div");k.classList.add("url-container");k.appendChild(h);k.appendChild(d);k.appendChild(c);e.appendChild(k);f.appendChild(e)})}
function setupPasswordValidation(a,f,b){const g=document.getElementById("password-form"),e=document.getElementById("password-input"),d=document.getElementById("password-submit");d.disabled=!0;e.addEventListener("blur",()=>{const c=e.value.trim();/^\d{4,10}$/.test(c)||c===""||(alert("\u5bc6\u78bc\u683c\u5f0f\u4e0d\u7b26\u5408\u8acb\u8f38\u51654~10\u4f4d\u6578\u5b57\nPassword format is incorrect. Please enter 4-10 digits."),e.value="",d.disabled=!0,setTimeout(()=>e.focus(),0))});e.addEventListener("input",
    ()=>{const c=e.value.trim();d.disabled=!/^\d{4,10}$/.test(c)});g.addEventListener("submit",async c=>{c.preventDefault();c=e.value.trim();if(c!==""){c={code:f,password:c};try{const k=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(k.ok){var h=await k.json();h.checkPassword?(h.token&&(authToken=h.token),hidePasswordModal(),initPage(b?"/is_api/downloadAlbumImages":"/is_api/downloadSingleImage",b)):(alert("\u5bc6\u78bc\u932f\u8aa4\u8acb\u91cd\u65b0\u8f38\u5165\nIncorrect password, please try again."),
    e.value="",d.disabled=!0,setTimeout(()=>e.focus(),0))}else alert("\u5bc6\u78bc\u9a57\u8b49\u5931\u6557\u8acb\u518d\u8a66\u4e00\u6b21\nPassword verification failed.")}catch(k){alert("\u7cfb\u7d71\u932f\u8aa4\u8acb\u7a0d\u5f8c\u518d\u8a66\nSystem error, please try again later.")}}})}
async function fetchWithRetry(a,f,b=3){let g=0;for(;g<b;)try{const e=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});if(e.status===429)await new Promise(d=>setTimeout(d,1E3)),g++;else{if(!e.ok){const d=await e.text();throw Error(`HTTP ${e.status}: ${d}`);}return e}}catch{break}throw Error("Too many attempts, please try again later.");}function showPasswordModal(){const a=document.getElementById("password-modal");a&&a.classList.remove("hidden")}
function hidePasswordModal(){const a=document.getElementById("password-modal");a&&a.classList.add("hidden")}function copyToClipboard(a){navigator.clipboard.writeText(a).catch(()=>{})}function showCopiedMessage(){const a=document.createElement("div");a.textContent="\u5df2\u8907\u88fd\u7db2\u5740 - URL Copied!";a.classList.add("toast-message");document.body.appendChild(a);setTimeout(()=>{document.body.removeChild(a)},1500)}
function downloadBlob(a,f){a=URL.createObjectURL(a);const b=document.createElement("a");b.href=a;b.download=f;document.body.appendChild(b);b.click();document.body.removeChild(b);URL.revokeObjectURL(a)}async function downloadByUrl(a,f){try{const b=await (await fetch(a,{mode:"cors"})).blob();downloadBlob(b,f)}catch{alert("\u4e0b\u8f09\u5931\u6557! - Download Failed!")}};