'use strict';let authToken;
document.addEventListener("DOMContentLoaded",async function(){const b=document.getElementById("scrollToTop");b&&(window.addEventListener("scroll",()=>{const c=window.scrollY;b.style.bottom=document.documentElement.scrollHeight-(c+window.innerHeight)<=175?"175px":"40px";b.classList.toggle("show",c>500)}),b.addEventListener("click",()=>{document.documentElement.scrollTo({top:0,behavior:"smooth"});document.body.scrollTo({top:0,behavior:"smooth"})}));var f=window.location.pathname;if(f==="/img_view")console.info("/img_view page accessed, skipping image loading logic.");
else{var a=f.startsWith("/a/");f=f.split("/")[2];var g=a?"/is_api/checkAlbumPassword":"/is_api/checkImagePassword",d=a?"/is_api/downloadAlbumImages":"/is_api/downloadSingleImage",e={code:f};try{const c=await (await fetchWithRetry(a?"/is_api/isAlbumPasswordNeeded":"/is_api/isImagePasswordNeeded",e)).json();c.isValid?c.requiresPassword?(showPasswordModal(),setupPasswordValidation(g,f,a)):(c.token&&(authToken=c.token),initPage(d,a)):window.location.href="/error_410"}catch(c){window.location.href="/error"}}});
async function initPage(b,f){hidePasswordModal();try{const a=await (await fetch(new URL(b,window.location.origin),{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${authToken}`},body:JSON.stringify({token:authToken})})).json();a.error?alert(a.error):f?await displayImagesSequentially(a):displaySingleImage(a)}catch(a){console.error("Error occurred during initPage execution:",a),alert("\u8f09\u5165\u5716\u7247\u5931\u6557\u8acb\u7a0d\u5f8c\u518d\u8a66\nFailed to load images. Please try again later.")}}
async function displayImagesSequentially(b){const f=document.getElementById("gallery");f.innerHTML="";f.classList.remove("hidden");var a=b.siaEndDate??"N/A",g=b.siaTotalVisited??0;const d=document.createElement("div");d.classList.add("status-area");d.innerHTML=`Expires on: ${a} | Views: ${g}`;f.appendChild(d);const e=document.createElement("div");e.classList.add("page-url-text");a=new URL(window.location.href);const c=a.host+a.pathname;e.innerHTML=`Share Gallery: ${c}`;e.addEventListener("click",
    function(){copyToClipboard(c);showCopiedMessage(e)});a=document.createElement("button");a.classList.add("download-album-button");a.innerHTML="\x26#11015;\x26#65039;";a.title="\u4e0b\u8f09\u6240\u6709\u5716\u7247 - Download Gallery";a.addEventListener("click",function(){downloadEntireAlbum(b.images)});g=document.createElement("div");g.classList.add("album-url-container");g.appendChild(e);g.appendChild(a);f.appendChild(g);a=b.siaNsfw===1;for(const h of b.images)await loadImageSequentially(h,f,a)}
function loadImageSequentially(b,f,a){return new Promise(g=>{const d=document.createElement("div");d.classList.add("photo");var e=document.createElement("img");e.src=(new URL(b.imageUrl,window.location.origin)).href;e.alt=b.siName;e.classList.add("gallery-image");e.onerror=function(){this.src="/images/pic_not_found.webp"};e.onload=()=>{g()};if(a){var c=document.createElement("div");c.classList.add("nsfw-mask");c.innerHTML="R15 or R18 Content\x3cbr\x3eNSFW - Click to reveal";c.addEventListener("click",
    ()=>{document.querySelectorAll(".nsfw-mask").forEach(l=>{l.style.display="none"})});d.appendChild(e);d.appendChild(c)}else d.appendChild(e);const h=document.createElement("div");h.classList.add("single-mode-text");h.innerHTML=`Share : ${b.imageSingleModeUrl}`;h.addEventListener("click",function(){copyToClipboard(b.imageSingleModeUrl);showCopiedMessage(h)});e=document.createElement("a");e.classList.add("open-link-button");e.innerHTML="\x26#128269;";e.title="\u539f\u59cb\u5c3a\u5bf8 - Full Size";e.href=
    b.imageUrl;e.target="_blank";e.rel="noopener noreferrer";c=document.createElement("a");c.classList.add("download-link-button");c.innerHTML="\x26#11015;\x26#65039;";c.title="\u4e0b\u8f09\u5716\u7247 - Download";c.addEventListener("click",async l=>{l.preventDefault();downloadByUrl(b.imageUrl,b.siName||"download.jpg")});const k=document.createElement("div");k.classList.add("url-container");k.appendChild(h);k.appendChild(e);k.appendChild(c);d.appendChild(k);f.appendChild(d)})}
function downloadEntireAlbum(b){if(b&&b.length!==0){var f=new JSZip,a=new URL(window.location.href),g=a.host+a.pathname;g=g.replace(/[\/:?*"<>|]/g,"_");var d=0;b.forEach(e=>{fetch(e.imageUrl).then(c=>c.blob()).then(c=>{let h=e.siName;h=h.replace(/[\/:?*"<>|]/g,"_");f.file(`${h}.jpg`,c);d++;d===b.length&&f.generateAsync({type:"blob"}).then(k=>{downloadBlob(k,`${g}.zip`)})}).catch(c=>console.error(`Error downloading ${e.imageUrl}:`,c))})}else console.error("No images to download.")}
function displaySingleImage(b){const f=document.getElementById("single-photo");f.innerHTML="";var a=b.siEndDate??"N/A",g=b.siTotalVisited??0,d=document.createElement("div");d.classList.add("status-area");d.innerHTML=`Expires on: ${a} | Views: ${g}`;const e=document.createElement("div");e.classList.add("page-url-text");const c=window.location.href;a=new URL(c);e.innerHTML=`Share: ${a.origin+a.pathname}`;e.addEventListener("click",function(){copyToClipboard(c);showCopiedMessage(e)});a=document.createElement("div");
    a.classList.add("photo-url-container");a.appendChild(d);a.appendChild(e);f.appendChild(a);a=document.createElement("div");a.classList.add("photo-wrapper");g=document.createElement("img");d=b.imageUrl.startsWith("http")?b.imageUrl:(new URL(b.imageUrl,window.location.origin)).href;g.src=d;g.alt=b.siName;g.id="photo-img";a.appendChild(g);if(b.siNsfw===1){const h=document.createElement("div");h.classList.add("nsfw-mask");h.textContent="NSFW - Click to reveal";h.addEventListener("click",()=>{h.classList.add("hidden")});
        a.appendChild(h)}f.appendChild(a);a=document.createElement("a");a.classList.add("open-link-button");a.innerHTML="\x26#128269;";a.title="\u539f\u59cb\u5c3a\u5bf8 - Full Size";a.href=d;a.target="_blank";a.rel="noopener noreferrer";d=document.createElement("a");d.classList.add("download-link-button");d.innerHTML="\x26#11015;\x26#65039;";d.title="\u4e0b\u8f09\u5716\u7247 - Download";d.addEventListener("click",async h=>{h.preventDefault();downloadByUrl(b.imageUrl,b.siName||"download.jpg")});g=document.createElement("div");
    g.classList.add("url-container");g.appendChild(a);g.appendChild(d);f.appendChild(g);f.classList.remove("hidden")}function showPasswordModal(){const b=document.getElementById("password-modal");b&&b.classList.remove("hidden")}function hidePasswordModal(){const b=document.getElementById("password-modal");b&&b.classList.add("hidden")}
function setupPasswordValidation(b,f,a){const g=document.getElementById("password-form"),d=document.getElementById("password-input"),e=document.getElementById("password-submit");e.disabled=!0;d.addEventListener("blur",function(){const c=d.value.trim();/^\d{4,10}$/.test(c)||c===""||(alert("\u5bc6\u78bc\u683c\u5f0f\u4e0d\u7b26\u5408\u8acb\u8f38\u51654~10\u4f4d\u6578\u5b57\nPassword format is incorrect. Please enter 4-10 digits."),d.value="",e.disabled=!0,setTimeout(()=>{d.focus()},0))});d.addEventListener("input",
    function(){var c=d.value.trim();c=/^\d{4,10}$/.test(c);e.disabled=!c});g.addEventListener("submit",async function(c){c.preventDefault();c=d.value.trim();if(c!==""){e.disabled=!0;c={code:f,password:c};try{const h=await (await fetchWithRetry(b,c)).json();h.checkPassword?(h.token&&(authToken=h.token),hidePasswordModal(),initPage(a?"/is_api/downloadAlbumImages":"/is_api/downloadSingleImage",a)):(alert("\u5bc6\u78bc\u932f\u8aa4\u8acb\u91cd\u65b0\u8f38\u5165\nIncorrect password, please try again."),d.value=
    "",e.disabled=!0,setTimeout(()=>{d.focus()},0))}catch(h){alert("\u7cfb\u7d71\u932f\u8aa4\u8acb\u7a0d\u5f8c\u518d\u8a66\nSystem error, please try again later."),e.disabled=!1}}})}async function fetchWithRetry(b,f,a=3){let g=0;for(;g<a;)try{const d=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});if(d.status===429)await new Promise(e=>setTimeout(e,1E3)),g++;else return d}catch(d){break}throw Error("Too many attempts, please try again later.");}
function copyToClipboard(b){navigator.clipboard.writeText(b).then(()=>{console.log("Text copied to clipboard:",b)}).catch(f=>{console.error("Failed to copy text: ",f)})}function showCopiedMessage(){const b=document.createElement("div");b.textContent="\u5df2\u8907\u88fd\u7db2\u5740 - URL Copied!";b.classList.add("toast-message");document.body.appendChild(b);setTimeout(()=>{document.body.removeChild(b)},1500)}
function downloadBlob(b,f){b=URL.createObjectURL(b);const a=document.createElement("a");a.href=b;a.download=f;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(b)}async function downloadByUrl(b,f){try{const a=await (await fetch(b,{mode:"cors"})).blob();downloadBlob(a,f)}catch(a){console.error("Download failed:",a),alert("\u4e0b\u8f09\u5931\u6557! - Download Failed!")}};