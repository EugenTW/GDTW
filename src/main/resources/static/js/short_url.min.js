document.addEventListener('DOMContentLoaded',function(){const longUrlInput=document.getElementById('long_url');const generateButton=document.getElementById('generate');const shortenUrlDisplay=document.getElementById('shorten_url');const qrcodeContainer=document.getElementById('qrcode');const maxRetries=5;function isValidUrl(url){if(!url||url.length>200)return!1;const httpsRegex=/^https:\/\/[a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,}(:\d+)?(\/.*)?$/;return httpsRegex.test(url)}
    function toggleButtonState(){const url=longUrlInput.value.trim();generateButton.disabled=!isValidUrl(url)}
    longUrlInput.addEventListener('input',toggleButtonState);longUrlInput.addEventListener('blur',function(){const url=longUrlInput.value.trim();if(!isValidUrl(url)){longUrlInput.value='';showAlert("請輸入有效的 HTTPS 網址，且不超過 200 字元。 - Please enter a valid HTTPS URL, and it should not exceed 200 characters.","darkred");generateButton.disabled=!0}});generateButton.addEventListener('click',function(){const longUrl=longUrlInput.value.trim();if(!isValidUrl(longUrl)){showAlert("請輸入正確的 URL（https 開頭且不超過 200 字元）。 - Please enter a correct URL (starting with https and not exceeding 200 characters).","darkred");return}
        generateButton.disabled=!0;let attempt=0;function tryCreateShortUrl(){fetch('/su_api/create_new_short_url',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({originalUrl:longUrl})}).then(response=>{if(response.status===429){attempt++;if(attempt<maxRetries){setTimeout(tryCreateShortUrl,1000)}else{shortenUrlDisplay.textContent="伺服器忙碌，稍後再試。 - Server busy. Try later.";shortenUrlDisplay.style.backgroundColor="pink";qrcodeContainer.style.display="none"}
            return null}
            return response.json()}).then(data=>{if(!data)return;const shortUrl=data.fullShortUrl;const message=data.message;if(shortUrl){shortenUrlDisplay.textContent=shortUrl;shortenUrlDisplay.style.backgroundColor="yellow";shortenUrlDisplay.onclick=()=>copyToClipboard(shortUrl);qrcodeContainer.innerHTML="";new QRCode(qrcodeContainer,{text:shortUrl,width:100,height:100});qrcodeContainer.style.display="block";copyToClipboard(shortUrl)}else{shortenUrlDisplay.textContent=message;shortenUrlDisplay.style.backgroundColor="pink";qrcodeContainer.style.display="none"}}).catch(err=>{console.error(err);shortenUrlDisplay.textContent="錯誤: 請稍後再試! Error: Please try again later.";shortenUrlDisplay.style.backgroundColor="pink";qrcodeContainer.style.display="none"}).finally(()=>{generateButton.disabled=!0})}
        tryCreateShortUrl()});function copyToClipboard(text){navigator.clipboard.writeText(text).then(()=>{showAlert("短網址已複製到剪貼簿 / The short URL is copied!","darkgreen")}).catch(err=>{console.error('Failed to copy text: ',err);showAlert("無法複製短網址 / Unable to copy the short URL.","darkred")})}
    function showAlert(message,color){const alertDiv=document.createElement("div");alertDiv.textContent=message;alertDiv.style.position="fixed";alertDiv.style.top="50%";alertDiv.style.left="50%";alertDiv.style.transform="translate(-50%, -50%)";alertDiv.style.backgroundColor=color||"#484848";alertDiv.style.color="#FFFFFF";alertDiv.style.padding="15px";alertDiv.style.borderRadius="5px";alertDiv.style.zIndex="9999";alertDiv.style.borderWidth="3px";document.body.appendChild(alertDiv);setTimeout(()=>{alertDiv.style.transition="opacity 0.3s";alertDiv.style.opacity=0;setTimeout(()=>alertDiv.remove(),300)},1500)}})